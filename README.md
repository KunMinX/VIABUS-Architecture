![image](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/viabuslogo.png)

![image](https://img.shields.io/badge/jcenter-0.4.1-brightgreen.svg)
![image](https://img.shields.io/badge/api-%2B15-blue.svg)
![image](https://img.shields.io/badge/license-Apache2.0-blue.svg)
![image](https://img.shields.io/badge/author-KunMinX-orange.svg)
![image](https://img.shields.io/badge/qqç¾¤-905136432-orange.svg)

### [ä¸­æ–‡æ–‡æ¡£](https://github.com/KunMinX/android-viabus-architecture/blob/master/README_CN.md) | [English](https://github.com/KunMinX/android-viabus-architecture/blob/master/README_EN.md)

# ä»€ä¹ˆæ˜¯ ViaBus
â­ ViaBus æ˜¯ä¸€æ¬¾å“åº”å¼æ¶æ„ï¼Œå€ŸåŠ©æ€»çº¿è½¬å‘æ•°æ®çš„è¯·æ±‚å’Œå“åº”ï¼Œå®ç°uiã€ä¸šåŠ¡çš„å®Œå…¨è§£è€¦ã€‚

![image](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/viabus_flow.png)

# ä¸ºä»€ä¹ˆé€‰æ‹© ViaBus 
- 1åˆ†é’Ÿå³å¯æŒæ¡ï¼ŒViaBus çš„ç»“æ„ä¸ä½¿ç”¨æ–¹å¼ã€‚ğŸ’¡
- å½“ä¸‹å°±å¯ä½¿ç”¨ï¼Œå¯¹åŸé¡¹ç›®æ¶æ„å®Œå…¨å…¼å®¹ï¼Œå³æ’å³ç”¨ã€‚ğŸ”¥
- å…è®¸ä»¥ ä¸šåŠ¡æˆ–æ¨¡å—ä¸ºå•ä½ï¼Œæ¯å¤©1å°æ—¶ï¼Œå®Œæˆæ¸è¿›å¼é‡æ„ã€‚ğŸ’§
- èŒè´£è¾¹ç•Œæ˜ç¡®ï¼Œæ— è®ºæ˜¯å†™ UI è¿˜æ˜¯ä¸šåŠ¡ï¼Œä¸å†è¢«æ‰“æ–­ã€ç›¸äº’ä¸æ‹–ç´¯ã€‚ğŸŒ±
- åŸç”Ÿæ¥å£å³å¯å®ç° è·¨ Activityã€è·¨ç»„ä»¶çš„ å®æ—¶åŒå‘é€šä¿¡ã€‚âš¡
- æ— ç¼–è¯‘æ—¶æ³¨è§£ï¼ŒåŸºäº Viabus ç¼–å†™çš„ç»„ä»¶å¯åœ¨ä»»ä½•é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨ã€‚ğŸŒ
- æ›´å°‘çš„é‡å¤å·¥ä½œï¼Œæ‰å¹³çš„äº¤äº’æ¨¡å¼ï¼Œä»£ç å¤ç”¨ç‡æå‡è‡³100%ã€‚ğŸ’ª
- ...

æ›´å¤šä¾æ®è¯¦è§ [Wiki - Androidï¼šå››å¤§æ¶æ„çš„ä¼˜ç¼ºç‚¹ï¼Œä½ çœŸçš„äº†è§£å—ï¼Ÿ](https://github.com/KunMinX/android-viabus-architecture/wiki/Android-%E5%90%84%E7%B1%BB%E6%9E%B6%E6%9E%84%E6%A8%AA%E5%90%91%E6%AF%94%E5%AF%B9)

# å¦‚ä½•ä½¿ç”¨ ViaBus 
åœ¨æ¨¡å—çš„ build.gradle æ·»åŠ å¦‚ä¸‹ä¾èµ–
```
implementation "com.kunminx.viabus:viabus-android:0.4.1"
```
ä½¿ç”¨æ–¹æ³•è¯¦è§ [Wiki - 1åˆ†é’ŸæŒæ¡ ViaBus æ¶æ„å’Œä½¿ç”¨](https://github.com/KunMinX/android-viabus-architecture/wiki/1%E5%88%86%E9%92%9F%E6%8E%8C%E6%8F%A1-ViaBus-%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BD%BF%E7%94%A8)

# è°åœ¨ç”¨ Viabus

|è§è¯è€…|Logo|ä½œå“åœ°å€æˆ–é¡¹ç›®é“¾æ¥|
|:--:|:--:|:--:|
|[MyateJx](https://github.com/MyateJx)|![sakernote](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/icon_sakernote.png)|[èˆ’å¿ƒå½• - é…·å®‰è€ç‰Œè®°äº‹æœ¬ app](https://www.coolapk.com/apk/com.myatejx.sakernote)|
|[MyateJx](https://github.com/MyateJx)|![gankio](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/icon_gank.png)|[gank.io å®¢æˆ·ç«¯](https://github.com/MyateJx/GankIo-viabus-architecture)|


# é¸£è°¢

RxJava

# License

```
Copyright 2018 KunMinX

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```
Â·
Â·
Â·
Â·
Â·
Â·
# ä½ è¿˜åœ¨ç­‰é‚£ä¸ªï¼Œæ‰‹æŠŠæ‰‹å¸¦ä½ é‡æ„çš„äººå‡ºç°å—ï¼Ÿ

## å‰è¨€

æœ¬æ–‡çš„ç¼–å†™ï¼Œå‰å‰ååç­¹å¤‡äº†ä¸¤ä¸ªç¤¼æ‹œã€‚

ä»¥ä¸‹ä½ å°±å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä½å•æªåŒ¹é©¬çš„å¸…å“¥ï¼Œæ˜¯å¦‚ä½•ä»¥ä¸€å·±ä¹‹åŠ›ï¼Œé‡æ„æ•´åº§â€œå±å±±â€çš„ã€‚

è¿™ä½å¸…å“¥ä¸€ç›´åœ¨å¾˜å¾Šï¼Œæœ¬æ–‡åˆ°åº•è¯¥å†™ç»™è°çœ‹ï¼Ÿæ˜¯åªåœ¨ä¹å†™åŠŸèƒ½çš„ç å†œå—ï¼Ÿä¸äº†ä¸äº†ï¼Œç å†œè‹¥çœŸçš„æœ‰å¿ƒæå‡ä»£ç è´¨é‡ï¼Œå°±ä¸ä¼šåœ¨é¡¹ç›®ä¸­ä¸§å¿ƒç—…ç‹‚çš„å †ç§¯å±å±±ã€‚

![](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/how_to_refact_project/ride_a_horse.webp)

äºæ˜¯å¹²è„†å†™å†™é‡æ„å¿ƒå¾—ã€åˆ†äº«é‡æ„æ€è·¯ï¼Œè®©é‚£äº›æœ‰æ„è¯†åœ¨è¿™æ–¹é¢æœ‰æ‰€æå‡çš„å¸…å“¥ç¾å¥³ä»¬ï¼Œå°‘èµ°å¼¯è·¯å§ï¼

>åœ¨æ­¤é¦–å…ˆæ„Ÿè°¢ä¸»ç®¡çš„ä¿¡ä»»ä¸æ”¯æŒã€‚æœ¬æ¬¡é‡æ„ä¸­ï¼Œå¸…å“¥åœ¨éƒ¨é—¨å†…éƒ¨å…œå”®å¹¶ç‡å…ˆä½¿ç”¨è‡ªä¸»è®¾è®¡çš„ Viabus æ¶æ„ï¼Œ5 å¤©å†…å®Œæˆ 60 ä¸ªç±»çš„æ ¸å¿ƒæ¨¡å—çš„é‡æ„ã€‚ï¼ˆä¸è¦æ…Œï¼Œæ­£å¦‚ä½ æ‰€è§åˆ°çš„ï¼Œæ¶æ„å·²åœ¨ GitHub å¼€æºï¼‰

ä»¥ä¸‹æ­£æ–‡ã€‚

## ä»£ç æ˜¯å¦‚ä½•è¶Šå†™è¶Šçƒ‚çš„ï¼Ÿ

ä½ æ˜¯å¦ç»å¸¸å¬åŒäº‹è‡ªå˜²ï¼Œâ€œå¼€å§‹è¿˜æƒ³å¥½å¥½å†™ï¼Œä¸çŸ¥æ€æ»´ï¼Œåé¢è¶Šå†™è¶Šçƒ‚â€ï¼Ÿ

ä»£ç è¶Šå†™è¶Šçƒ‚ï¼ŒæœçœŸæ˜¯ä¸ªæ²¡æœ‰ç«¯å€ªã€æ— æ³•å¹²é¢„çš„é­”å’’ç„å­¦å—ï¼Ÿ

è®©æˆ‘ä»¬æ¥**å¿«é€Ÿæµè§ˆä¸€ä¸‹** é‡æ„å‰ é¡¹ç›®é‡Œçš„ä»£ç æ˜¯æ€ä¹ˆå†™çš„ã€‚

```
protected void initView() {
        PagerAdapter pagerAdapter = new PagerAdapter();
        viewPagerFix.setOffscreenPageLimit(4);
        viewPagerFix.setAdapter(pagerAdapter);
        mFragmentBinding.tabLayout.setTabData(pagerAdapter.titles);
        mFragmentBinding.tabLayout.setOnTabSelectListener(new OnTabSelectListener() {
            @Override
            public void onTabSelect(int position) {
                viewPagerFix.setCurrentItem(position);
            }

            @Override
            public void onTabReselect(int position) {

            }
        });
        viewPagerFix.addOnPageChangeListener(new ViewPagerFix.OnPageChangeListener() {
            @Override
            public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {
                KeyboardUtils.hideSoftInput(getActivity());
            }

            @Override
            public void onPageSelected(int position) {
                mFragmentBinding.tabLayout.setCurrentTab(position);
                if (mViewModel.getXXXDetailTouchManager().isZZBG()) { 

                    zzbgPageSelected(position);

                } else if (mViewModel.getXXXDetailTouchManager().isYBJZ()) { 
                    switch (position) {
                        case 0:
                        case 1:
                            mViewModel.removeAllArrows();

                            if (mAttachmentFragment != null) {
                                mAttachmentFragment.hideClickHighLight(ALBUM_ALL);
                            }
                            break;
                        case 2:
                            if (mAttachmentFragment != null) {
                                mAttachmentFragment.initAttachTitle();
                            }
                            mViewModel.showAllArrows();

                            break;
                        default:
                            break;
                    }
                } else {
                    switch (position) {
                        case 0:
                        case 1:
                        case 2:
                            mViewModel.removeAllArrows();
                            //hideBottomLayout();
                            if (mAttachmentFragment != null) {
                                mAttachmentFragment.hideClickHighLight(ALBUM_ALL);
                            }
                            break;
                        case 3:
                            if (mAttachmentFragment != null) {
                                mAttachmentFragment.initAttachTitle();
                            }
                            mViewModel.showAllArrows();

                            break;
                        default:
                            break;
                    }
                }
            }

            @Override
            public void onPageScrollStateChanged(int state) {

            }
        });
        viewPagerFix.setCurrentItem(0);
        mFragmentBinding.headContainer.getTitleView().setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (mViewModel.getXXXDetailTouchManager().isZZBG()) { 
                    return;
                }

                mViewModel.changeWyhcrwMajorState(); 
                EventBus.getDefault().post(new RefreshItemEventBus(
                        mViewModel.getXXXDetailTouchManager().getCurrentWyhcrw()));
            }
        });
    }

    private void zzbgPageSelected(int position) {

        if (mScreenNum == 3) {

            switch (position) {
                case 0:
                case 1:
                    mViewModel.removeAllArrows();

                    if (mAttachmentFragment != null) {
                        mAttachmentFragment.hideClickHighLight(ALBUM_ALL);
                    }
                    break;
                case 2:
                    mViewModel.showAllArrows();

                    break;
                default:
                    break;
            }

        } else {

            switch (position) {
                case 0:
                    mViewModel.removeAllArrows();

                    if (mAttachmentFragment != null) {
                        mAttachmentFragment.hideClickHighLight(ALBUM_ALL);
                    }
                    break;
                case 1:
                    mViewModel.showAllArrows();

                    break;
                default:
                    break;
            }

        }
        ;

    }



    /**
     * viewPageré€‚é…å™¨
     */
    private class PagerAdapter extends FragmentPagerAdapter {

        String[] titles;

        PagerAdapter() {
            super(getChildFragmentManager());
            if (mViewModel.getXXXDetailTouchManager().isZZBG()) {

                if (mScreenNum == 3) {

                    titles = getResources().getStringArray(R.array.XXX_detail_tabs_for_no_tbjt);

                } else {
                    titles = getResources().getStringArray(R.array.XXX_detail_tabs_for_zzbg);

                }

            } else if (mViewModel.getXXXDetailTouchManager().isYBJZ()) {
                titles = getResources().getStringArray(R.array.XXX_detail_tabs_for_ybjz);
            } else {
                titles = getResources().getStringArray(R.array.XXX_detail_tabs);
            }
        }

        @Override
        public Fragment getItem(int position) {
            if (mViewModel.getXXXDetailTouchManager().isZZBG()) {

                return zzbgGetItem(position);

            } else if (mViewModel.getXXXDetailTouchManager().isYBJZ()) {
                switch (position) {
                    case 0:
                        if (mXXXTuBanPicFragment == null) {
                            mXXXTuBanPicFragment = XXXTuBanPicFragment.newInstance(
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger()
                            );
                        }
                        return mXXXTuBanPicFragment;
                    case 1:
                        if (mRecordFragment == null) {
                            mRecordFragment = XXXRecordFragment.newInstance(mViewModel.getXXXDetailTouchManager());
                        }
                        return mRecordFragment;

                    default:
                        if (mAttachmentFragment == null) {
                            mAttachmentFragment = XXXAttachmentFragment.newInstance(
                                    mViewModel.getAttachments(),
                                    mViewModel.getOriginalAttachments(),
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger(),
                                    XXXDetailFragment.this
                            );
                        }
                        return mAttachmentFragment;
                }
            } else {
                switch (position) {
                    case 0:
                        if (mXXXTuBanPicFragment == null) {
                            mXXXTuBanPicFragment = XXXTuBanPicFragment.newInstance(
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger()
                            );
                        }
                        return mXXXTuBanPicFragment;
                    case 1:
                        if (mAttributeFragment == null) {
                            mAttributeFragment = XXXAttributeFragment.newInstance(
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger()
                            );
                        }
                        return mAttributeFragment;

                    case 2:
                        if (mRecordFragment == null) {
                            mRecordFragment = XXXRecordFragment.newInstance(mViewModel.getXXXDetailTouchManager());
                        }
                        return mRecordFragment;
                    default:
                        if (mAttachmentFragment == null) {
                            mAttachmentFragment = XXXAttachmentFragment.newInstance(
                                    mViewModel.getAttachments(),
                                    mViewModel.getOriginalAttachments(),
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger(),
                                    XXXDetailFragment.this
                            );
                        }
                        return mAttachmentFragment;
                }
            }
        }

        private Fragment zzbgGetItem(int position) {

            if (mScreenNum == 3) {

                switch (position) {
                    case 0:
                        if (mAttributeFragment == null) {
                            mAttributeFragment = XXXAttributeFragment.newInstance(
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger()
                            );
                        }
                        return mAttributeFragment;
                    case 1:
                        if (mRecordFragment == null) {
                            mRecordFragment = XXXRecordFragment.newInstance(
                                    mViewModel.getXXXDetailTouchManager());
                        }
                        return mRecordFragment;
                    default:
                        if (mAttachmentFragment == null) {
                            mAttachmentFragment = XXXAttachmentFragment.newInstance(
                                    mViewModel.getAttachments(),
                                    mViewModel.getOriginalAttachments(),
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger(),
                                    XXXDetailFragment.this
                            );
                        }
                        return mAttachmentFragment;
                }

            } else {
                switch (position) {
                    case 0:
                        if (mRecordFragment == null) {
                            mRecordFragment = XXXRecordFragment.newInstance(
                                    mViewModel.getXXXDetailTouchManager());
                        }
                        return mRecordFragment;
                    default:
                        if (mAttachmentFragment == null) {
                            mAttachmentFragment = XXXAttachmentFragment.newInstance(
                                    mViewModel.getAttachments(),
                                    mViewModel.getOriginalAttachments(),
                                    mViewModel.getUniqueCode(),
                                    mViewModel.getXXXTouchManger(),
                                    XXXDetailFragment.this
                            );
                        }
                        return mAttachmentFragment;
                }
            }

        }

        @Override
        public Object instantiateItem(ViewGroup container, int position) {
            Object object = super.instantiateItem(container, position);
            if (mViewModel.getXXXDetailTouchManager().isZZBG()) {
                if (mScreenNum == 3) {

                    switch (position) {
                        case 0:
                            mAttributeFragment = (XXXAttributeFragment) object;
                            break;
                        case 1:
                            mRecordFragment = (XXXRecordFragment) object;
                            break;
                        default:
                            mAttachmentFragment = (XXXAttachmentFragment) object;
                            break;
                    }

                } else {
                    switch (position) {
                        case 0:
                            mRecordFragment = (XXXRecordFragment) object;
                            break;
                        default:
                            mAttachmentFragment = (XXXAttachmentFragment) object;
                            break;
                    }
                }

                return object;
            } else if (mViewModel.getXXXDetailTouchManager().isYBJZ()) {
                switch (position) {
                    case 0:
                        mXXXTuBanPicFragment = (XXXTuBanPicFragment) object;
                        break;
                    case 1:
                        mRecordFragment = (XXXRecordFragment) object;
                        break;
                    default:
                        mAttachmentFragment = (XXXAttachmentFragment) object;
                        break;
                }
                return object;
            } else {
                switch (position) {
                    case 0:
                        mXXXTuBanPicFragment = (XXXTuBanPicFragment) object;
                        break;
                    case 1:
                        mAttributeFragment = (XXXAttributeFragment) object;
                        break;
                    case 2:
                        mRecordFragment = (XXXRecordFragment) object;
                        break;
                    default:
                        mAttachmentFragment = (XXXAttachmentFragment) object;
                        break;
                }
                return object;
            }
        }

        @Override
        public int getCount() {
            if (mViewModel != null) {
                if (mViewModel.getXXXDetailTouchManager().isZZBG()) {
                    if (mScreenNum == 3) {
                        return 3;
                    }
                    return 2;
                }
                if (mViewModel.getXXXDetailTouchManager().isYBJZ()) {
                    return 3;
                } else {
                    return 4;
                }
            }
            return 0;
        }

    }

 
```

ï¼ˆä¸ºä¿æŠ¤éšç§ï¼Œæ¨¡å—ç±»åå·²æ›¿æ¢ä¸ºâ€œXXXâ€ï¼‰

å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ä¸»é¡µç›®å‰æœåŠ¡äº 3 ä¸ªåœ°åŒºï¼Œæ¯ä¸ªåœ°åŒºå¯¹å­é¡µé¢çš„å±•ç¤ºéƒ½æœ‰å®šåˆ¶éœ€æ±‚ã€‚

if else switch if else switchï¼Œåªåœ¨ä¹åŠŸèƒ½å®ç°çš„ç å†œå°±æ˜¯è¿™ä¹ˆå†™çš„ã€‚

ä¸€ä¸ªåœ°åŒº 50 è¡Œï¼Œé‚£è¦æ˜¯ 10 ä¸ªåœ°åŒºå‘¢ï¼Ÿå…¬å¸é¢†å¯¼æ”¾è¯è¦æ”¯æŒå…¨å›½ 100 ä¸ªä¹¡é•‡åœ°åŒºï¼é‚£ 100 ä¸ªåœ°åŒºå‘¢ï¼Ÿï¼Ÿï¼Ÿ

![](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/how_to_refact_project/add_100_area.webp)


## æŠ½è±¡ï¼Œé¡ºåº”çš„æ˜¯â€œå¼€é—­åŸåˆ™â€

è¿™æ˜¯ä¸€å¸®å¯¹â€œæŠ½è±¡â€æ— æ„Ÿçš„ç å†œã€‚

ä»–ä»¬å¬åˆ°â€œæŠ½è±¡â€ï¼Œå°±åƒä¸çˆ±é”»ç‚¼çš„äººå¬åˆ°çˆ¶æ¯ã€æœ‹å‹åŠå…¶â€œå¥èº«â€ä¸€æ ·è¢«åŠ¨ã€‚

æ­£å¦‚ä»–ä»¬ä¸ç†è§£å¥èº«çš„æ„ä¹‰æ‰€åœ¨ï¼Œä»–ä»¬ä¹Ÿå½“æŠ½è±¡æ˜¯â€œè€³è¾¹é£â€ã€‚

â€œ100 ä¸ªåœ°åŒºâ€è¿™ç§ï¼Œå¤©ç„¶çš„å°±æ˜¯ç”¨å·¥å‚æ¨¡å¼æ¥æŠ½è±¡å’Œå®šåˆ¶ï¼Œè¿™åŸæœ¬æ˜¯ä¸€ç›®äº†ç„¶ã€æ¯«æ— ç–‘é—®çš„äº‹ã€‚

é‡æ„åçš„ä»£ç ï¼Œä¸»é¡µæŠ¬å¤´ç‰¹æ„æ ‡æ³¨äº†è­¦å‘Šã€‚

```
/
 * å‹æƒ…æç¤ºï¼šæœ¬ç±»æ¶‚æœ‰é˜²è…è¯å“ï¼Œåˆ‡å‹¿è§¦ç¢°ï¼Œåˆ‡å‹¿è§¦ç¢°ï¼Œåˆ‡å‹¿è§¦ç¢°ï¼
 * <p>
 * åœ°åŒºå®šåˆ¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç‰¹è‰²çš„å¸ƒå±€ç­‰ï¼Œè¯·ç»§æ‰¿äº AbstractDetailChildFragmentManager å•ç‹¬ç¼–å†™ï¼
 */

public class XXXDetailFragment extends BaseFragment implements IResponse {
    protected void initView() {
        initViewPagerManager();
        PagerAdapter pagerAdapter = new PagerAdapter();
        viewPagerFix.setOffscreenPageLimit(4);
        viewPagerFix.setAdapter(pagerAdapter);
        mFragmentBinding.tabLayout.setTabData(pagerAdapter.titles);
        mFragmentBinding.tabLayout.setOnTabSelectListener(new OnTabSelectListener() {
            @Override
            public void onTabSelect(int position) {
                viewPagerFix.setCurrentItem(position);
            }

            @Override
            public void onTabReselect(int position) {

            }
        });
        viewPagerFix.addOnPageChangeListener(new ViewPagerFix.OnPageChangeListener() {
            @Override
            public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {
                KeyboardUtils.hideSoftInput(getActivity());
            }

            @Override
            public void onPageSelected(int position) {
                mFragmentBinding.tabLayout.setCurrentTab(position);
                mDetailChildFragmentManager.onPageSelected(position);
            }

            @Override
            public void onPageScrollStateChanged(int state) {

            }
        });
    }

    /**
     * viewPageré€‚é…å™¨
     */
    private class PagerAdapter extends FragmentPagerAdapter {

        String[] titles;

        PagerAdapter() {
            super(getChildFragmentManager());
            titles = mDetailChildFragmentManager.getTitles();
        }

        @Override
        public Fragment getItem(int position) {
            return mDetailChildFragmentManager.getItem(position);
        }

        @Override
        public Object instantiateItem(ViewGroup container, int position) {
            Object object = super.instantiateItem(container, position);
            return mDetailChildFragmentManager.instantiateItem(container, position, object);
        }

        @Override
        public int getCount() {
            return mDetailChildFragmentManager.getCount();
        }
    }
}

```

## ä»£ç æ˜¯å¦‚ä½•å‰ªä¸æ–­ç†è¿˜ä¹±çš„ï¼Ÿ

å¬è¯´è¿‡â€œä»£ç è€¦åˆâ€å’Œâ€œè§£è€¦â€çš„äººå¾ˆå¤šï¼Œä½†çœŸæ­£ç†è§£è¿™æ˜¯æ€ä¹ˆä¸€å›äº‹çš„ï¼Œ**ææ€•åªæœ‰ä½  ~**

![](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/how_to_refact_project/so_what.webp)


å› ä¸ºå“ªæ€•ä½ ä¸çŸ¥ï¼Œä½ ä¹Ÿå³å°†è§è¯ä¸€ä½å¸…å“¥å¦‚ä½•æ‰‹æŠŠæ‰‹å¸¦ä½ è§£è€¦ ~

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é‡æ„å‰çš„ä»£ç ï¼

```
public interface XXXListNavigator {

    void updateRecyclerView();

    void showProgressDialog();

    void dismissProgressDialog();

    void updateListView();

    void updateLayerWrapperList(List<LayerWrapper> list);

    boolean isAnimationFinish();

    void resetCount();

}

public class XXXListViewModel extends BaseViewModel {
    public void multiAddOrRemove(ArrayList<String> bsms, boolean isAdd) {
        if (null != mNavigator) {
            mNavigator.showProgressDialog();
        }
        if (null == mMultiAddOrRemoveUseCase) {
            mMultiAddOrRemoveUseCase = new MultiAddOrRemoveUseCase();
        }
        mUseCaseHandler.execute(mMultiAddOrRemoveUseCase, new MultiAddOrRemoveUseCase.RequestValues(isAdd, bsms,
                        mLayerWrapperObservableField.get()),
                new UseCase.UseCaseCallback<MultiAddOrRemoveUseCase.ResponseValue>() {
                    @Override
                    public void onSuccess(MultiAddOrRemoveUseCase.ResponseValue response) {
                        ToastUtils.showShort(getApplicationContext(), "æ“ä½œæˆåŠŸ");
                        clearData();
                        loadData(true, true);
                        if (null != mNavigator) {
                            mNavigator.dismissProgressDialog();
                        }
                    }

                    @Override
                    public void onError() {
                        ToastUtils.showShort(getApplicationContext(), "æ“ä½œå¤±è´¥");
                        if (null != mNavigator) {
                            mNavigator.dismissProgressDialog();
                        }
                    }
                });
    }
}

```

å¯ä»¥çœ‹åˆ°ï¼ŒUI è¿‡åº¦æš´éœ²äº†â€œå¤„ç† UI é€»è¾‘æ‰€ä¾èµ–çš„è¿‡ç¨‹ APIâ€ï¼Œå¹¶åœ¨ä¸šåŠ¡ä¸­ç›´æ¥å¹²é¢„äº† UI é€»è¾‘ï¼Œè¿™æ˜¯å…¸å‹çš„ MVP å†™æ³•ï¼Œè¿™é€ æˆäº†è€¦åˆã€‚ä¸€æ—¦ UI çš„éœ€æ±‚æœ‰å˜åŠ¨ï¼ŒView å’Œ Presenter çš„ç¼–å†™è€…éƒ½ä¼šå—åˆ°ç‰µè¿ã€‚

è€Œä¸”ï¼ŒèŒè´£è¿‡å¤šé€ æˆäº†ä¾èµ–è¿‡å¤šï¼Œè¿™ä¸ª Presenter ä¼šå› ä¸ºè¿‡å¤šçš„ä¾èµ–ï¼Œè€Œè¶Šå†™è¶Šè‡ƒè‚¿ï¼šå—â€œç ´çª—æ•ˆåº”â€çš„é©±ä½¿ï¼Œåˆ«çš„ç å†œä¼šå› ä¸ºæ­¤å¤„å·²ç»æœ‰æŸä¸ªä¾èµ–ï¼Œè€Œä¸å‡æ€ç´¢çš„æ¥ç€å¾€ä¸‹å†™ã€‚

## åˆ°åº•æ€æ ·æ‰ç®—è§£è€¦

æ‰€è°“è§£è€¦ï¼Œæ˜¯ç¬¦åˆå·¥ç¨‹è®¾è®¡ã€ç¬¦åˆè®¾è®¡æ¨¡å¼åŸåˆ™çš„ç¼–ç ã€‚

è§£è€¦çš„æœ¬è´¨ï¼Œæˆ‘åªè¯´ä¸€éï¼š

**èŒè´£è¾¹ç•Œæ˜ç¡®ï¼ŒèŒè´£è¾¹ç•Œæ˜ç¡®ï¼ŒèŒè´£è¾¹ç•Œæ˜ç¡®ã€‚**

![](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/viabus_flow_flow_detail.png)


**ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ï¼š**
UI çš„èŒè´£ä»…é™äºâ€œå±•ç¤ºâ€ï¼Œä¹Ÿå°±æ˜¯å‘é€è¯·æ±‚ã€å¤„ç† UI é€»è¾‘ã€‚ä¸šåŠ¡çš„èŒè´£ä»…é™äºâ€œæä¾›æ•°æ®â€ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶è¯·æ±‚ã€å¤„ç†ä¸šåŠ¡é€»è¾‘ã€å“åº”ç»“æœæ•°æ®ã€‚

**ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ã€æœ€å°çŸ¥è¯†åŸåˆ™ï¼š**
UI ä¸éœ€è¦çŸ¥é“æ•°æ®æ˜¯ç»è¿‡æ€æ ·çš„å‘¨è½¬å¾—æ¥çš„ï¼Œå®ƒåªéœ€å‘é€è¯·æ±‚ï¼Œå¹¶åœ¨æ‹¿åˆ°ç»“æœæ•°æ®åï¼Œè‡ªå·±å†…éƒ¨æ¶ˆåŒ– UI é€»è¾‘ã€‚ä¸šåŠ¡åªéœ€å¤„ç†æ•°æ®å¹¶å“åº”æ•°æ®ç»™ UIï¼Œå®ƒä¸éœ€è¦çŸ¥é“ UI ä¼šæ€æ ·ä½¿ç”¨æ•°æ®ï¼Œæ›´æ— æƒå¹²é¢„ã€‚

ç»¼ä¸Šï¼Œæ— è®ºæ˜¯ UI è¿˜æ˜¯ä¸šåŠ¡ï¼Œéƒ½ä¸åº”è¿‡åº¦æš´éœ²å†…éƒ¨é€»è¾‘ API è€Œå—æ§äºäººï¼Œ**å®ƒä»¬åº”åªæš´éœ²è¯·æ±‚ APIï¼Œæ¥å“åº”å¤–éƒ¨çš„è¯·æ±‚ã€‚è¿‡ç¨‹é€»è¾‘åº”åªåœ¨è‡ªå·±å†…éƒ¨ç‹¬ç«‹æ¶ˆåŒ–**ã€‚

```
public class XXXListBusinessProxy extends BaseBusiness<XXXBus> implements IXXXListFragmentRequest {

	@Override
    public void multiAddOrRemove(final XXXListDTO dto) {
        handleRequest((e) -> {
				...
                if (TextUtils.isEmpty(existBsms)) {
                    sendMessage(e, new Result(XXXDataResultCode.XXX_LIST_FRAGMENT_MULTI_ADD_OR_REMOVE, false));
                } else {
                    wyhcJgDBManager.insertAllTaskOfMine(existBsms, layersConfig);
                    sendMessage(e, new Result(XXXDataResultCode.XXX_LIST_FRAGMENT_MULTI_ADD_OR_REMOVE, true));
                }
                return null;
        });
    }

    @Override
    public void refreshPatternOfXXXList(final XXXListDTO dto) {
        handleRequest((e) -> {
				...
                count.setMyXXXCount(wyhcJgDBManager.getMyXXXPatternCount());
                return new Result(XXXDataResultCode.XXX_LIST_FRAGMENT_REFRESH_COUNT, count);
        });
    }

    @Override
    public void changeXXXPatternOfMine(final XXXListDTO dto) {
        handleRequest((e) -> {
                if (toMine) {
                    ...
                } else {
					...		
                    sendMessage(e, new Result(XXXDataResultCode.XXX_LIST_FRAGMENT_GET_ALL_PATTERN_OF_MINE, count));
                }
                return null;
        });
    }
}



public class XXXListFragment extends BaseFragment implements IResponse {

	XXXBus.XXX().queryList(mDto);
	
	XXXBus.XXX().multiAddOrRemove(mDto);
	
	XXXBus.XXX().queryPattern(mDto);

	...

	@Override
    public void onResult(Result testResult) {
        String code = (String) testResult.getResultCode();
        switch (code) {
            case XXXDataResultCode.XXX_LIST_FRAGMENT_REFRESH_LIST:
                updateRecyclerView((List<Wyhcrw>) testResult.getResultObject());
                if (isNeedUpdateCount()) {
                    ...
                } else {
                    finishLoading();
                }
                break;
            case XXXDataResultCode.XXX_LIST_FRAGMENT_MULTI_ADD_OR_REMOVE:
                if ((boolean) testResult.getResultObject()) {
                    loadData(true, true);
                } else {
                    ToastUtils.showShort(getContext(), "æ“ä½œå¤±è´¥");
                }
                dismissProgressDialog();
                break;
			case XXXDataResultCode.XXX_LIST_FRAGMENT_REFRESH_PATTERN:
				...
				break;
			default:
        }
    }
}

```

## è§£è€¦æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

è§£è€¦çš„å¥½å¤„ï¼Œç¦ç‰¹æœ€æœ‰è¯è¯­æƒã€‚

100 å¤šå¹´å‰ï¼Œç¦ç‰¹å‘æ˜äº†ä¸–ç•Œä¸Šç¬¬ä¸€æ¡æµæ°´çº¿ï¼Œè®©å·¥äººèŒè´£è¾¹ç•Œæ˜ç¡®ï¼Œä»è€Œå¾—ä»¥åˆ†å·¥å’Œä¸“æ³¨å„è‡ªé¢†åŸŸã€‚

åŸå…ˆè£…é…ä¸€è¾†è½¦éœ€ 700 å°æ—¶ï¼Œé€šè¿‡æµæ°´çº¿åˆ†å·¥åï¼Œå¹³å‡ä¸€è¾† 12.5 å°æ—¶ï¼Œè¿™ä½¿å¾—ç”Ÿäº§æ•ˆç‡æå‡äº†è¿‘ 60 å€ï¼

![](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/how_to_refact_project/assemble_line.webp)


è½¯ä»¶å·¥ç¨‹åŒç†ã€‚

ç”±äº UI å’Œä¸šåŠ¡èŒè´£è¾¹ç•Œæ˜ç¡®ï¼Œä¸”ç›¸äº’é€šè¿‡æ¥å£é€šä¿¡ï¼Œä½¿å¾— UI å’Œä¸šåŠ¡çš„ç¼–å†™è€…èƒ½å¤Ÿ**çœŸæ­£çš„åˆ†å·¥**ã€‚

å†™ UI çš„äººï¼Œä¸ä¼šè¢«ä¸šåŠ¡çš„ç¼–å†™æ‰“æ–­ï¼Œä»–å¯ä»¥ä¸€æ°”å‘µæˆçš„å†™è‡ªå·±çš„ UIã€‚å†™ä¸šåŠ¡çš„äººï¼ŒåŒæ ·**ä¸ä¼šè¢«æ‰“æ–­**ï¼Œä»–å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€æ•°æ®ç»“æ„å’Œç®—æ³•çš„ä¼˜åŒ–ã€‚

å†™ UI å’Œå†™ä¸šåŠ¡çš„äººï¼Œéƒ½å¯ä»¥è‡ªå·±å®ç°æ¥å£ï¼Œå»**ç‹¬ç«‹çš„å®Œæˆå•å…ƒæµ‹è¯•**ï¼Œå®Œå…¨ä¸å¿…ä¾èµ–å’Œç­‰å€™å¯¹æ–¹çš„å®ç°ã€‚

æœ€åï¼Œåœ¨èŒè´£è¾¹ç•Œæ˜ç¡®çš„æƒ…å†µä¸‹ï¼ŒUI å°±ç®—å†™ 100 ä¸ª UI é€»è¾‘ï¼Œé‚£ä¹Ÿæ˜¯ UIï¼Œä¸šåŠ¡å°±ç®—å†™ 100 ä¸ªä¸šåŠ¡ï¼Œé‚£ä¹Ÿæ˜¯ä¸šåŠ¡ï¼Œ**çº¯ç§ï¼Œæ‰€ä»¥ä¸ä¼šæ‚ä¹±**ï¼Œä½•å†µæˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ©â€œæ¥å£éš”ç¦»åŸåˆ™â€ç»§ç»­å¾€ä¸‹åˆ†å·¥ï¼

...

## æ€»ç»“

ç»¼ä¸Šï¼Œæœ¬æ–‡ä»‹ç»äº†ä¸¤ä¸ªé‡æ„æ€è·¯ï¼š
**1.é¡ºåº”å¼€é—­åŸåˆ™ï¼Œå¯¹å®šåˆ¶åŒ–åŠŸèƒ½è¿›è¡ŒæŠ½è±¡ã€‚**
**2.é¡ºåº”å•ä¸€èŒè´£ã€æœ€å°çŸ¥è¯†ã€ä¾èµ–å€’ç½®åŸåˆ™ï¼Œè®©èŒè´£è¾¹ç•Œæ˜ç¡®ï¼Œé˜²æ­¢ä»£ç è€¦åˆã€‚**

æœ¬æ¬¡é¡¹ç›®é‡æ„ç”¨åˆ°çš„ï¼Œç¬¦åˆè®¾è®¡æ¨¡å¼åŸåˆ™çš„ viabus æ¶æ„ï¼Œå·²åœ¨ GitHub å¼€æºã€‚

å¦‚æœä½ è§‰å¾—æœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œæ¬¢è¿ Star & Forkã€‚ç›¸ä¿¡ä¼šæœ‰ä¸€å¤©ï¼Œä½ ä¹Ÿå¯ä»¥ï¼Œé«˜æ•ˆç‡çš„ç¼–å†™å’Œé‡æ„ä»£ç ï¼

![](https://github.com/KunMinX/android-viabus-architecture/blob/master/images/how_to_refact_project/good_luck.webp)


